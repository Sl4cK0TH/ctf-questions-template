<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ 'Edit' if challenge else 'New' }} Challenge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- SortableJS for drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body class="admin-page">
    <div class="top-bar">
        <h1>{{ 'Edit' if challenge else 'New' }} Challenge</h1>
        <a href="{{ url_for('admin.dashboard') }}" class="logout-btn">← Back</a>
    </div>

    <div class="admin-container">
        <form method="POST" class="challenge-form" id="challenge-form">
            <div class="form-section">
                <h3>Challenge Details</h3>

                <div class="form-group">
                    <label>Name</label>
                    <input type="text" name="name" value="{{ challenge.name if challenge else '' }}" required
                        placeholder="e.g., Pcap-a-Boo">
                </div>

                <div class="form-group">
                    <label>Slug (URL)</label>
                    <input type="text" name="slug" value="{{ challenge.slug if challenge else '' }}" required
                        placeholder="e.g., pcap-a-boo">
                    <span class="hint">Will be accessible at /c/slug</span>
                </div>

                <div class="form-group">
                    <label>
                        Description (Welcome Text)
                        <span class="label-hint">Supports Markdown & HTML</span>
                    </label>
                    <div class="editor-wrapper">
                        <div class="editor-toolbar">
                            <button type="button" class="toolbar-btn active" data-mode="edit" onclick="toggleDescriptionMode('edit')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                                </svg>
                                Edit
                            </button>
                            <button type="button" class="toolbar-btn" data-mode="preview" onclick="toggleDescriptionMode('preview')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                Preview
                            </button>
                        </div>
                        <textarea name="description" id="description-editor" rows="6"
                            placeholder="Welcome message shown to participants... (Markdown supported)">{{ challenge.description if challenge else '' }}</textarea>
                        <div id="description-preview" class="markdown-preview" style="display: none;"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Flag</label>
                        <input type="text" name="flag" value="{{ challenge.flag if challenge else '' }}" required
                            placeholder="rsuCTF{...}">
                    </div>

                    <div class="form-group">
                        <label>Passing Score</label>
                        <input type="number" name="passing_score"
                            value="{{ challenge.passing_score if challenge else 0 }}" min="0">
                        <span class="hint">0 = All questions required</span>
                    </div>
                </div>

                {% if challenge %}
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" name="is_active" {{ 'checked' if challenge.is_active else '' }}>
                        Active (visible to participants)
                    </label>
                </div>
                {% endif %}

                <button type="submit" class="btn btn-submit" id="save-btn">
                    {{ 'Save Changes' if challenge else 'Create Challenge' }}
                </button>
            </div>
        </form>

        {% if challenge %}
        <div class="form-section questions-section">
            <div class="section-header-flex">
                <h3>Questions</h3>
                <div id="save-status" class="save-status"></div>
            </div>

            <div id="questions-list">
                {% for q in questions %}
                <div class="question-item" data-id="{{ q.id }}" data-order="{{ q.order_num }}">
                    <div class="question-header">
                        <span class="drag-handle" title="Drag to reorder">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="16" y2="6"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                                <line x1="8" y1="18" x2="16" y2="18"></line>
                            </svg>
                        </span>
                        <span class="q-num">#{{ loop.index }}</span>
                        <div class="question-actions-header">
                            <button type="button" class="toolbar-btn small active" data-mode="edit" onclick="toggleQuestionMode({{ q.id }}, 'edit')" title="Edit">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                                </svg>
                            </button>
                            <button type="button" class="toolbar-btn small" data-mode="preview" onclick="toggleQuestionMode({{ q.id }}, 'preview')" title="Preview">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                            <button type="button" class="btn-delete" onclick="deleteQuestion({{ q.id }})" title="Delete">×</button>
                        </div>
                    </div>
                    <div class="question-body">
                        <div class="question-field">
                            <label>Question <span class="label-hint">Markdown & HTML supported</span></label>
                            <textarea class="q-text" placeholder="Enter your question..." rows="3">{{ q.question }}</textarea>
                            <div class="q-text-preview markdown-preview" style="display: none;"></div>
                        </div>
                        <div class="answer-row">
                            <div class="answer-field">
                                <label>Answer</label>
                                <input type="text" class="q-answer" value="{{ q.answer }}" placeholder="Correct answer...">
                            </div>
                            <div class="match-field">
                                <label>Match Type</label>
                                <select class="q-match">
                                    <option value="exact" {{ 'selected' if q.match_type=='exact' else '' }}>Exact Match</option>
                                    <option value="case_insensitive" {{ 'selected' if q.match_type=='case_insensitive' else '' }}>Case Insensitive</option>
                                    <option value="contains" {{ 'selected' if q.match_type=='contains' else '' }}>Contains</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <button type="button" class="btn btn-add" onclick="addQuestion()" style="margin-top: 15px;">+ Add Question</button>
        </div>

        <div class="form-section danger-zone">
            <h3>Danger Zone</h3>
            <form method="POST" action="{{ url_for('admin.delete_challenge', challenge_id=challenge.id) }}"
                onsubmit="return confirm('Are you sure? This will delete the challenge and all its questions.')">
                <button type="submit" class="btn btn-danger">Delete Challenge</button>
            </form>
        </div>
        {% endif %}
    </div>

    <script>
        const challengeId = {{ challenge.id if challenge else 'null' }};
    </script>
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
</body>

</html>
